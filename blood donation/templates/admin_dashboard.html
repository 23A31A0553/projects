{% extends 'base.html' %}

{% block content %}
<h1 style="color: var(--secondary);">Admin Dashboard</h1>

<div class="grid mt-2">
    <div class="card">
        <h3>Total Donors</h3>
        <p style="font-size: 2rem; color: var(--primary);">{{ donors|length }}</p>
    </div>
    <div class="card">
        <h3>Total Requests</h3>
        <p style="font-size: 2rem; color: var(--accent);">{{ requests|length }}</p>
    </div>
    <div class="card">
        <h3>People Helped</h3>
        <p style="font-size: 2rem; color: green;">{{ helped }}</p>
    </div>
    <div class="card" style="display: flex; align-items: center; justify-content: center; background: #f9f9f9;">
        <a href="{{ url_for('manage_hospitals') }}" class="btn" style="background: var(--accent);">üè• Manage
            Hospitals</a>
    </div>
</div>

<div class="grid mt-2">
    <div class="card">
        <h3>Analytics</h3>
        <canvas id="bloodChart"></canvas>
    </div>
    <div class="card">
        <h3>Requests Status</h3>
        <canvas id="reqChart"></canvas>
    </div>
</div>

<h2 class="mt-2">Registered Donors</h2>
<div style="overflow-x: auto;">
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Group</th>
                <th>City</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for donor in donors %}
            <tr>
                <td>{{ donor.full_name }}<br><small>{{ donor.mobile_number }}</small></td>
                <td>{{ donor.blood_group }}</td>
                <td>{{ donor.city }}</td>
                <td>
                    {% if donor.is_approved %}
                    <span style="color: green;">Active</span>
                    {% else %}
                    <span style="color: red;">Blocked</span>
                    {% endif %}
                </td>
                <td>
                    {% if donor.is_approved %}
                    <a href="{{ url_for('approve_user', user_id=donor.id, action='block') }}"
                        style="color: orange; font-size: 0.8rem;">Block</a>
                    {% else %}
                    <a href="{{ url_for('approve_user', user_id=donor.id, action='approve') }}"
                        style="color: green; font-size: 0.8rem;">Approve</a>
                    {% endif %}
                    <a href="{{ url_for('edit_user', user_id=donor.id) }}"
                        style="color: var(--secondary); margin-left: 5px;">Edit</a>
                    <a href="{{ url_for('delete_user', user_id=donor.id) }}" onclick="return confirm('Delete user?')"
                        style="color: #d00000; margin-left: 5px;">&times;</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h2 class="mt-2">Blood Requests</h2>
<div style="overflow-x: auto;">
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Group</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requests %}
            <tr>
                <td>{{ req.patient_name }}</td>
                <td>{{ req.blood_group }}</td>
                <td>
                    <span style="background: {{ req.status_color }}; padding: 2px 6px; border-radius: 4px;">{{
                        req.status }}</span>
                </td>
                <td>
                    <!-- Future: Mark Fulfilled -->
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    fetch('/api/admin/stats')
        .then(response => response.json())
        .then(data => {
            // Blood Group Chart
            new Chart(document.getElementById('bloodChart'), {
                type: 'bar',
                data: {
                    labels: data.blood_groups,
                    datasets: [{
                        label: 'Donors',
                        data: data.blood_counts,
                        backgroundColor: '#d00000'
                    }]
                }
            });

            // Request Status Chart
            new Chart(document.getElementById('reqChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Fulfilled'],
                    datasets: [{
                        data: data.req_status,
                        backgroundColor: ['#orange', '#28a745']
                    }]
                }
            });
        });
</script>
{% endblock %}