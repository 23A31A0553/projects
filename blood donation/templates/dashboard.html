{% extends 'base.html' %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1 style="color: var(--secondary);">Welcome, {{ user.full_name }}</h1>
    <p>Last Donation:
        {% if user.last_donation_date %}
        <strong>{{ user.last_donation_date }}</strong>
        {% else %}
        <span style="color: green;">Never (Ready to Donate!)</span>
        {% endif %}
    </p>
</div>

<div class="grid">
    <!-- Action Card -->
    <div class="card">
        <h3>ü©∏ Actions</h3>
        <p>You can request blood or update your availability.</p>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <a href="{{ url_for('request_blood') }}" class="btn">Request Blood</a>
            <!-- Future: Edit Profile Link -->
        </div>
    </div>

    <!-- Stats Card -->
    <div class="card" style="border-left-color: var(--secondary);">
        <h3>‚ù§Ô∏è Your Status</h3>
        <p>Availability: <strong>{{ 'Available' if user.is_available else 'Not Available' }}</strong></p>
        <p>Blood Group: <strong>{{ user.blood_group }}</strong></p>
        <p>Health Score: Good</p>
    </div>
</div>

<h2 class="mt-2" style="border-bottom: 2px solid #eee; padding-bottom: 0.5rem;">Your Blood Requests</h2>
{% if requests %}
<table>
    <thead>
        <tr>
            <th>Patient</th>
            <th>Group</th>
            <th>Hospital</th>
            <th>Status</th>
            <th>Date</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for req in requests %}
        <tr>
            <td>{{ req.patient_name }}</td>
            <td>{{ req.blood_group }}</td>
            <td>{{ req.hospital_name }}</td>
            <td>
                <span style="padding: 2px 8px; border-radius: 4px; background: {{ req.status_color }};">
                    {{ req.status }}
                </span>
            </td>
            <td>{{ req.created_at.strftime('%Y-%m-%d') }}</td>
            <td>
                <a href="{{ url_for('find_donors', req_id=req.id) }}" style="color: var(--accent);">View Donors</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p style="margin-top: 1rem; color: #666;">You haven't made any blood requests yet.</p>
{% endif %}

<h2 class="mt-2" style="border-bottom: 2px solid #eee; padding-bottom: 0.5rem; margin-top: 2rem;">Requests Near You</h2>
{% if nearby_requests %}
<div style="overflow-x: auto;">
    <table>
        <thead>
            <tr>
                <th>Patient</th>
                <th>Group</th>
                <th>Hospital</th>
                <th>Urgency</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for req in nearby_requests %}
            <tr>
                <td>{{ req.patient_name }}</td>
                <td><strong style="color: var(--secondary);">{{ req.blood_group }}</strong></td>
                <td>{{ req.hospital_name }}<br><small>{{ req.hospital_location }}</small></td>
                <td>{{ req.urgency_level }}</td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="tel:{{ req.contact_number }}" class="btn"
                            style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">üìû Call</a>
                        <a href="{{ url_for('chat', partner_id=req.requester_id) }}" class="btn"
                            style="padding: 0.2rem 0.5rem; font-size: 0.8rem; background: var(--secondary);">üí¨ Chat</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p style="color: #666;">No active blood requests found nearby.</p>
{% endif %}
{% endblock %}